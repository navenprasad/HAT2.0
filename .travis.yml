language: scala

dist: trusty

sudo: required

services:
  - docker

scala:
  - 2.11.8

jdk:
  - oraclejdk8

addons:
  postgresql: "9.5"

cache:
  directories:
  - $HOME/.sbt
  - $HOME/.ivy2

notifications:
  slack:
    secure: m77P/oPazWaem1QdYeCE3Qs/lSS1T4KGpX8g8VCHwABff09QWzTzHXEnYHnDNNDnwWJWC+CWIlfEIFcgUQDVBFYETSJ44HzopZBm2WJRTCMessaMBvALLqUyXprGxgrKcvBDPOWGP3fIeGBKAIdC/AiB82AJ7kXZWnoWrUwokdsrgwL4FzxjqnXuTAG1+mltdXcB3WVle7KqpeCOmJo5Kwg3dwDcJamcElyxIcJId2Lwg70NKNSLNupv3M2i2/GE8s6p2pVuPfynIJVmyYSBXUboQ4Y/zsL3iTHmsLD38L4avz4bvcHLPm7Lb0fUI0prwBEftjpiEZYNNSczLk1XfffFSrfAhmgT9HGmO4ra4Eeps4vsuaFAFD8CHjhnohg2Gp77Xzc43FTh3pmxDeb+K34a+yncGljFuneCF0vZRZQ5R7it/fsUBtNhYnwwS88GCG1L9ZyUKE2qwYVSwq4TyEHnTMvdxCeNzYV/Mnw+FjpvGO9uLCtVvvdZP4Tt+YqajPT+XgtcDPvoWb8MO2CoyMCnvFEU4nT87ks7hwxT+Hv5SsPU/XZdgm6ahelpwWWoNaMgs0nYRdVeV3kPEP3GSKeD/hOd/5UhFa7r9u5Ir9ZhjMrEi6eUgoOk8TMdXNHtTgxzO4AxVnrelCIbJQ4SH8LGqOLVJHWTF0mLVxcsBzE=
    on_success: always # default: always
    on_failure: change # default: always

branches:
  only:
    - master
    - testing
    - dev

# Handle git submodules yourself
git:
    submodules: false

env:
  global:
    - RUMPEL_BUCKET=rumpel-build-artifacts
    - AWS_DEFAULT_REGION=eu-west-1
    - secure: rGkp2QHhU+T5VvIRYALgwCPkUqP64vZjVaUgmqt2B53N1hxLuJs3FMc9qdd3+0SJTTFndGSsGjANE6Nb6FZeEoT1OB8TQvW9ZOGZCbggpZLFfAEudZo4lzLBR0PASa7nJyyvlVaxuay7g6K0Llqm1Lfphd/1FAW6bmDORwJIbikak7ejfwAWoZCrzp5xmTsC7OZ6Th1dJ5HLCZhionPQ8jp1nEedrbC4a4ryop9D7vlF+zu7vxTd/ZHC41mKGUdrfCyzkWGhK58Ne1dNdHYiP/Arj30m0s36alkPsXeZnnfbWYqy+6u9KkR0Rt+cIgJALkIYY/aQQIqvREsaN4hcYn6DP02J8Yw0GUDDV+Mu1V+kCdWHI6izoJZjlGmZ6uXbABXbEiYFlp2j+JEa89B1diEL8sQ7qFShUs1/cUOGg1XYEyZq4ht8peIGhoTADHNFO+mSt6R8jxZThzD5YXJ7miAMvXCwENNEEZZQ32K7Ar2IREa99FLTpSSduQHz6TH8upZMICFHXwdM/Z2P72jELQ/cRBT3WkHGUm5pncOklu/zb1D7quvSm2sd97hVKczTxHM74XdBVhWEGEPpj+bzRhzKISDYlwDngCO08fv5HefqSbgewk0Ks+HhYb7aHOlmk5B568rymGD2VQJIGRD+Acyp1PrEyBNcVyfYtYAMHKw=
    - secure: mXXvzrn94Nb6YWEskkdidDisSb2ncIX+8fnfBC7Z2zwgITHCa2kHva54fs8qMH5CAFTm6ROx+l3ejbYvUWiHQeLMefzXrnTicB7XAfYKkOfM2V5jmuweNFkn+AozZOos5vPfcuribrlHck57C9LcpkhkZARgNKaWskLFSTmwWjFRiaf0tqFm+8kaa01obu4SQLaYmyfmyUDVJga3L9HiZ8VybeaP3rYp0Z1vpX5+foqRmwFSHpcKiIrBjBzqMm/Tkf6R9gceXsCaZVmlfmyCuKxFos0Js0EwYX+xaduVKZU8xSwQ1p9m/r69qAlFQ2/Nd1iIYasTE1VY7O/FAIUz0N8S0R6SL0D5TwqNvS6lhUjPpn+vI3co5EvMtiVJ9E2ebBkKTvNJ1131rIwecIqUStDvCCFLMwuHDsSwtiAj/mTiuggK0dS4GGYFrTx5qxHR+9SUSGHIezgqEXXU3Ok9FPVRTNOxV97AMOQciXictroSX2Arpdho677/rpIkPnhJmxbUMe5x+TxnvyUdbMF3eDV22RlnJEp7wM12FrwVOUAYYDvpAg6RhCo3maV8e27en+DYWmP/oQaVnwWCkgYjKl+SdrNZf85gDdsPbU8yrVdNlpAeKfc6YgFSXdkyC06ma1t7BPgsyv7O25i0VgoFBbkhTQ/M2P599o0cGKuY8l4=
    - secure: FddHp3GoD9WReR3N1OD9Kxva5Kj9mP6BIKEKj0xNexZydWgGsgChxaE9IXY984XkrZtiwlJv/DirBOOnEy/s6NrUcmWwvQ0enJfYSrk3U4oLkZLvY2UfM6HClGwtjilw1dIKNkhCi+Snc9kskAxnZqcxiJhzKj9EajCkyCXdDTNuMneF+xZ+xp9RlC2M7soM+QRVLjUwzG4iUOU76VuZY/femXIeMnXq8WHZ8/BxK7UDIUAzCzkYokIcVfylVUJ/1jzMWn2oixXL9BRO1Tkusw6AM8dVKnkSP/uaW7ANHo2KVGHGdGb8/dxuyMX0BmXMX+LbrJ5ogz5CKhPy4lw3MulD/ymrYf3s4y2JqeFbZqJtnWNuw6dtCRIIFrncQDRWOQ/GtI0OcrFWmnm3xGVQevWbIlD0APew0F86gAu75xO6THvnB5XXTClfIkH9dRnapjwNsKx4gztKB1v4DHcyP0QK24wvjF1OXGkIxZm16HlM4ug2p2N68py62FNqWnunIitB+LwhzfZN86pbgX85NAeVf90QVCj3yRzHu1wyDb82CSy89cziQGiTK26/rMPUBhedq84I9UkrMLV9grLHwcwKWd1QP/5BiwepSWMFRCM+XlFhyFvx5Wau2FN0PA5NP2u/aln7jAVux8yA9OFl/eT4W12+pl8AlLdo3inLINQ=
    - secure: OXuaV2AZAeAFTVJQ2OjJrVvLHUdmwihz3Ygv5TXPtG91qWAZy7eZN3za0IJagGFPSEUecLe3CZK898hwNWAQftX4R2NL19BBeyIkh3G2eOyLV8SZWuuOT7lR5FM2a5qYRCuVEVYv3LQ+O/WjDOvG2TJgKVB3xNuLDZL4oQIRpno4N8M67Pz1uGk2PnlWvj5q8lJ4tK77hGfg4SZ4xjX/TT/EqZ4lNdSUynEmqObNX7IXRa2rUUE//1t6zNvZ3/OAYHGap7vTvQYmY6P4dcfFNZIxWqcoZVTy0ijahmxdru6FP8ydCfXeNiKJ9Mt2wGPdsWRJIi639lBHdnqLXFQeWkQUHhPVLkaXjf2nQ+KryFNHyHn34PpeDzFAJ/pDgLWClS/jwxQng96/qmv+Aip6+0XJn7kgT+BI0e/4Jfa0XBZ8PI9XH3yoQ7iIKQLAXJQPmFd3fr+5Fdu6+5hQMNGF/q+CBUkRcTElDr0dvCrJe1trYnO9lMd9JgJKqjLKfssqDMJza5K/7m7e5Z6mj+xeqEsWdkg0H+HGwpUnf6X5Nz0RkcQFK0bLzqizovN8+H/V0p2nhgh9O1XbN2wu44Qq4ZcJVNUHSJ45FU2d6UmtJvjGbwg0STm+QuLgO5PYvaTVNkUiBctbblhjKm1OmpfqJgjs8TebuWhvFtAFZ/j/tT0=
  matrix:
#    - REPOSITORY_NAME=hubofallthings RUMPEL=hubofallthings
#    - REPOSITORY_NAME=hubat RUMPEL=hubat
    - REPOSITORY_NAME=xtiva RUMPEL=xtiva

# Use sed to replace the SSH URL with the public URL, then initialize submodules
before_install:
  - sed -i 's/git@github.com:/https:\/\/github.com\//' .gitmodules
  - git submodule update --init --recursive

install:
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin

before_script:
  - psql -c "CREATE DATABASE testhatdb1;" -U postgres
  - psql -c "CREATE USER testhatdb1 WITH PASSWORD 'testing';" -U postgres
  - psql -c "GRANT CREATE ON DATABASE testhatdb1 TO testhatdb1" -U postgres
  - cd ./hat/app/org/hatdex/hat/phata/assets/
  - aws s3 cp s3://${RUMPEL_BUCKET}/${RUMPEL} rumpel --recursive
  - cp rumpel/*.js* js/
  - gzip --keep --force js/*.bundle.js
  - cp -r rumpel/assets .
  - rm -r rumpel
  - cd -

script:
  - sbt clean
  - sbt ++$TRAVIS_SCALA_VERSION compile test:compile
  - sbt coverage "testOnly org.hatdex.hat.api.*" -Dconfig.file=src/main/resources/application.test.conf
  - sbt coverageReport
  - sbt coverageAggregate
  - sbt "project hat" docker:stage
  - cd hat/target/docker/stage && docker build -t ${REPOSITORY_NAME}/hat:${TRAVIS_COMMIT} . && cd -

after_success:
  - sbt coveralls

deploy:
  - provider: script
    script:
      - env AWS_SECRET_ACCESS_KEY=${DEPLOY_AWS_SECRET_ACCESS_KEY} && env AWS_ACCESS_KEY_ID=${DEPLOY_AWS_ACCESS_KEY_ID}
      - ECR_REPOSITORY=$(aws ecr describe-repositories --repository-name ${REPOSITORY_NAME} --query 'repositories[0].repositoryUri' --output text)
      - eval $(aws ecr get-login --no-include-email)
      - docker tag ${REPOSITORY_NAME}/hat:${TRAVIS_COMMIT} ${ECR_REPOSITORY}:${TRAVIS_COMMIT}
      - docker push ${ECR_REPOSITORY}:${TRAVIS_COMMIT}
    on:
      repo: Hub-of-all-Things/HAT2.0
      branch: dev